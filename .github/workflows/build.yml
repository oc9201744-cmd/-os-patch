name: Build GeminiBypass with Theos

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Manuel çalıştırabilmek için

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Theos & SDKs
        run: |
          git clone --recursive https://github.com/theos/theos.git $HOME/theos
          git clone --depth=1 https://github.com/theos/sdks.git $HOME/theos/sdks
          echo "THEOS=$HOME/theos" >> $GITHUB_ENV
          echo "THEOS_DEVICE_IP=127.0.0.1" >> $GITHUB_ENV  # Dummy, paketleme için
          echo "PATH=$HOME/theos/bin:$PATH" >> $GITHUB_ENV

      - name: Install Build Tools
        run: |
          brew install cmake ldid dpkg xz

      - name: Create Theos Project Structure (eğer yoksa)
        run: |
          cd $GITHUB_WORKSPACE
          if [ ! -f Makefile ]; then
            echo "Makefile yok, basit tweak şablonu oluşturuyoruz..."
            $THEOS/bin/nic.pl <<EOF
            iphone/tweak
            GeminiBypass
            com.yourname.geminibypass
            Your Name
            EOF
          fi

      - name: Copy Your Source Files
        run: |
          cp -f src/GeminiMemoryPatch.cpp Tweak.xm || echo "Tweak.xm'e kopyalandı"

      - name: Update Makefile for your tweak
        run: |
          cat > Makefile <<EOF
          include \$(THEOS)/makefiles/common.mk

          TWEAK_NAME = GeminiBypass
          GeminiBypass_FILES = Tweak.xm

          include \$(THEOS_MAKE_PATH)/tweak.mk
          EOF

      - name: Build and Package
        run: |
          cd $GITHUB_WORKSPACE
          make package FINALPACKAGE=1 || echo "Make package hatası - log'a bak"

      - name: List Packages
        run: ls -la packages/ || true

      - name: Upload .deb Artifact
        uses: actions/upload-artifact@v4
        with:
          name: GeminiBypass-Deb
          path: packages/*.deb