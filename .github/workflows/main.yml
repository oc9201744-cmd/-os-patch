name: build-dobby-ios-arm64

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clone Dobby
        run: |
          git clone https://github.com/jmpews/Dobby.git dobby
          cd dobby
          git submodule update --init --recursive

      - name: Build dobby.a (iOS arm64, no codesign)
        run: |
          cd dobby
          mkdir build
          cd build

          SDK=$(xcrun --sdk iphoneos --show-sdk-path)

          clang++ -arch arm64 \
            -isysroot $SDK \
            -std=c++17 \
            -fPIC -fvisibility=hidden \
            -DDOBBY_GENERATE_SHARED=0 \
            -I../include \
            -I../source \
            -I../external \
            ../source/*.cc \
            ../source/**/*.cc \
            ../external/**/*.cc \
            -c

          libtool -static -o dobby.a *.o

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: dobby-ios-arm64
          path: dobby/build/dobby.a