name: Baybars-Build-Engine

on:
  workflow_dispatch: # Manuel başlatma butonu

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
      - name: Repoyu Cek
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Xcode Ortamini Hazirla
        run: |
          # Hatalı xcode-select yollarını temizle ve varsayılanı kullan
          sudo xcode-select -r
          xcrun --sdk iphoneos --show-sdk-path
          
      - name: CMAKE Kurulumu
        run: |
          # Eğer yüklü değilse kur, yüklüyse güncelleme yapma (vakit kazan)
          if ! command -v cmake &> /dev/null; then
            brew install cmake
          fi

      - name: Build Scriptini Calistir
        run: |
          chmod +x build.sh
          # Ortam değişkenlerini script'e hazır veriyoruz
          export TARGET_OS="ios"
          export BUILD_TYPE="Release"
          
          # Scripti çalıştır (Hikari kapalı, CMake ile)
          ./build.sh -s cmake -t Release -h OFF -o ios
        
      - name: Dylibleri Topla ve Yukle
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Baybars-Final-Dylib
          path: |
            release/ios/*.dylib
            release/ios/*.tar.gz
            cmake-build-Release/*.dylib
