name: Otomatik Tweak Derleyici V45

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Kodu GitHub'dan Çek
        uses: actions/checkout@v4

      - name: Gerekli Araçları Kur
        run: |
          brew install ldid make
          echo "THEOS=~/theos" >> $GITHUB_ENV

      - name: Theos Ortamını Hazırla
        run: |
          git clone --recursive https://github.com/theos/theos.git ~/theos

      - name: iOS SDK Kurulumu (Git Clone Yöntemi - HATASIZ)
        run: |
          # curl yerine git clone kullanarak LFS pointer hatasını engelliyoruz
          git clone --depth 1 https://github.com/theos/sdks.git ~/theos/sdks

      - name: Tweak'i Derle (Dylib Oluştur)
        run: |
          export THEOS=~/theos
          export PATH=$THEOS/bin:$PATH
          
          # Tweak.mm ve ban korumalı ayarlarınla derle
          make package \
            TWEAK_NAME=SecureBypass \
            SecureBypass_FILES=Tweak.mm \
            FINALPACKAGE=1 \
            DEBUG=0 \
            STRIP=1 \
            SIGN_SKIP=1 \
            CODESIGN_IPA=0 \
            ARCHS="arm64 arm64e" \
            TARGET="iphone:clang:latest:14.0"

      - name: Derlenen Dosyayı (Artifact) Teslim Et
        uses: actions/upload-artifact@v4
        with:
          name: SecureBypass-V45
          path: |
            .theos/obj/debug/*.dylib
            packages/*.deb
