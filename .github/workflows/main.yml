name: Build iOS Dylib with Dobby

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install deps
      run: |
        brew install cmake

    - name: Clone Dobby
      run: |
        git clone https://github.com/jmpews/Dobby.git

    - name: Build Dobby (iOS arm64)
      run: |
        cd Dobby
        xcodebuild \
          -project Dobby.xcodeproj \
          -scheme dobby \
          -sdk iphoneos \
          -arch arm64 \
          -configuration Release \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGN_IDENTITY="" \
          DEVELOPMENT_TEAM=""

    - name: Build dylib
      run: |
        clang++ \
          -dynamiclib \
          -arch arm64 \
          -isysroot $(xcrun --sdk iphoneos --show-sdk-path) \
          -framework Foundation \
          Tweak.xm \
          Dobby/build/Release-iphoneos/libdobby.a \
          -o tweak.dylib

    - name: Upload dylib
      uses: actions/upload-artifact@v4
      with:
        name: tweak-dylib
        path: tweak.dylib